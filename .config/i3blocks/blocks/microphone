#!/usr/bin/env bash
set -u

# =========================================================
# SCRIPT: mic-manager.sh
# DESCRIZIONE: Gestione del microfono (Sorgente Audio) via pactl
#              - Click sinistro: Mute/Unmute toggle
#              - Rotella su/giÃ¹: Volume +/- 5%
# DIPENDENZE: bash, pulseaudio-utils (pactl), alsa-utils
# =========================================================

# --- CONFIGURAZIONE ---
SRC='@DEFAULT_SOURCE@'
VOL_STEP="5%"

COLOR_ON="#FFFFFF"
COLOR_MUTE="#EF5350"

# --- AZIONI (Click e Scroll) ---
case "${BLOCK_BUTTON:-0}" in
    1) pactl set-source-mute "$SRC" toggle ;;
    4) pactl set-source-volume "$SRC" +"$VOL_STEP" ;;
    5) pactl set-source-volume "$SRC" -"$VOL_STEP" ;;
esac

# --- LOGICA DI RILEVAMENTO ---

# Stato Mute (yes/no)
MIC_MUTE=$(pactl get-source-mute "$SRC" 2>/dev/null | awk '{print $2}' | head -n1)

# Volume (estrae la prima percentuale trovata, es: 55%)
MIC_PERC=$(pactl get-source-volume "$SRC" 2>/dev/null | grep -oP '\d+(?=%)' | head -n1)

# Fallback se i dati sono mancanti
[[ -z "${MIC_PERC:-}" ]] && MIC_PERC="0"

# --- DETERMINAZIONE OUTPUT ---

if [[ "${MIC_MUTE:-yes}" == "no" ]]; then
    COLOR="$COLOR_ON"
    TEXT="MIC [${MIC_PERC}%]"
    SHORT="${MIC_PERC}%"
else
    COLOR="$COLOR_MUTE"
    TEXT="MIC [MUTE]"
    SHORT="MUT"
fi

# --- OUTPUT I3BLOCKS ---
echo "$TEXT"    # Full text
echo "$SHORT"   # Short text
echo "$COLOR"   # Color
