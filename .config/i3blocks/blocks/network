#!/usr/bin/env bash
set -u

# --- Helpers ---
is_admin_up() {
  # tun0/wg0 spesso hanno operstate=unknown ma flag UP: questo li prende
  ip -o link show dev "$1" 2>/dev/null | grep -q '<[^>]*UP[^>]*>'
}

has_carrier() { [[ -r "/sys/class/net/$1/carrier" ]] && [[ "$(cat "/sys/class/net/$1/carrier" 2>/dev/null)" == "1" ]]; }
is_wifi() { [[ -d "/sys/class/net/$1/wireless" ]]; }

get_ssid() { iw dev "$1" link 2>/dev/null | awk -F': ' '/SSID/ {print $2; exit}'; }
get_ipv4() { ip -o -4 addr show dev "$1" 2>/dev/null | awk '{print $4}' | cut -d/ -f1 | head -n1; }
get_ipv6() { ip -o -6 addr show dev "$1" 2>/dev/null | awk '{print $4}' | cut -d/ -f1 | grep -v '^fe80:' | head -n1; }

default_dev() {
  ip -o route show default 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="dev"){print $(i+1); exit}}'
}

launch_nm() {
  if command -v xdg-terminal-exec >/dev/null 2>&1; then
    xdg-terminal-exec --title="nmtui-terminal" -- nmtui
  else
    (nmtui >/dev/null 2>&1 </dev/null &)
  fi
}

# --- Click actions (sinistro) ---
case "${BLOCK_BUTTON:-}" in
  1) (launch_nm >/dev/null 2>&1 </dev/null &) ;;
esac

DEF_DEV="$(default_dev || true)"

# --- Trova interfacce attive ---
ACTIVE=()
for IF in $(ls /sys/class/net 2>/dev/null); do
  [[ "$IF" == "lo" ]] && continue
  is_admin_up "$IF" || continue

  IPV4="$(get_ipv4 "$IF")"
  IPV6="$(get_ipv6 "$IF")"

  if is_wifi "$IF"; then
    SSID="$(get_ssid "$IF")"
    # wifi attivo se associato o ha IP
    [[ -n "${SSID:-}" || -n "${IPV4:-}" || -n "${IPV6:-}" ]] && ACTIVE+=("$IF")
  else
    # wired/tunnel attivi se carrier=1 oppure ha IP (tun0/wg0 rientrano qui)
    [[ "$(has_carrier "$IF" && echo 1 || echo 0)" == "1" || -n "${IPV4:-}" || -n "${IPV6:-}" ]] && ACTIVE+=("$IF")
  fi
done

# --- Right click notify (info importanti) ---
if [[ "${BLOCK_BUTTON:-}" == "3" ]]; then
  if ((${#ACTIVE[@]} == 0)); then
    notify-send "Rete" "Offline"
  else
    MSG="Default: ${DEF_DEV:-<none>}"
    for IF in "${ACTIVE[@]}"; do
      IPV4="$(get_ipv4 "$IF")"
      IPV6="$(get_ipv6 "$IF")"
      if is_wifi "$IF"; then
        SSID="$(get_ssid "$IF")"
        MSG+=$'\n\n'"$IF (wifi): ${SSID:-<no ssid>}"$'\n'"IPv4: ${IPV4:-<none>}  IPv6: ${IPV6:-<none>}"
      else
        # se Ã¨ tunnel tipico, etichettalo
        TYPE="wired"
        [[ "$IF" =~ ^(tun|tap|wg|vpn)[0-9]+$ ]] && TYPE="vpn"
        MSG+=$'\n\n'"$IF (${TYPE}):"$'\n'"IPv4: ${IPV4:-<none>}  IPv6: ${IPV6:-<none>}"
      fi
    done
    notify-send "Rete" "$MSG"
  fi
fi

# --- Output i3blocks ---
if ((${#ACTIVE[@]} == 0)); then
  echo "NET [OFF]"
  echo ""
  echo "#EF5350"
elif [[ -z "${DEF_DEV:-}" ]]; then
  # interfacce attive ma niente default route => "no internet"
  echo "NET [${ACTIVE[*]}]"
  echo ""
  echo "#EF5350"
else
  # evidenzia la default route con *
  for i in "${!ACTIVE[@]}"; do
    [[ "${ACTIVE[$i]}" == "$DEF_DEV" ]] && ACTIVE[$i]="${ACTIVE[$i]}*"
  done

  echo "NET [${ACTIVE[*]}]"
  echo ""
  echo "#C3E88D"
fi


