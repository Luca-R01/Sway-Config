#!/usr/bin/env bash
set -u

# =========================================================
# SCRIPT: bluetooth-manager.sh
# DESCRIZIONE: Monitora e controlla lo stato del Bluetooth
#              - Click sinistro: Toggle Power (On/Off)
#              - Click destro: Apre Blueman Manager (se installato)
# DIPENDENZE: bash, bluetoothctl, libnotify, blueman-manager
# =========================================================

# --- CONFIGURAZIONE ---
COLOR_ON="#FFFFFF"
COLOR_OFF="#EF5350"

# --- HELPERS ---

# Ottiene lo stato attuale (yes/no)
get_status() {
    bluetoothctl show 2>/dev/null | awk -F': ' '/Powered:/ {print $2; exit}'
}

# --- AZIONI (Click) ---

case "${BLOCK_BUTTON:-0}" in
    1) # Click Sinistro: Toggle Power
        CURRENT_STATUS=$(get_status)
        if [[ "${CURRENT_STATUS:-no}" == "no" ]]; then
            bluetoothctl power on >/dev/null 2>&1
            notify-send "Bluetooth" "Dispositivo Attivato"
        else
            bluetoothctl power off >/dev/null 2>&1
            notify-send "Bluetooth" "Dispositivo Disattivato"
        fi
        ;;
    3) # Click Destro: Interfaccia GUI
        if command -v blueman-manager >/dev/null 2>&1; then
            (blueman-manager >/dev/null 2>&1 &)
        fi
        ;;
esac

# --- LOGICA DI OUTPUT ---

# Recuperiamo lo stato aggiornato (necessario dopo un eventuale click)
STATUS=$(get_status)

if [[ "${STATUS:-no}" == "yes" ]]; then
    COLOR="$COLOR_ON"
    TEXT="BT [ON]"
    SHORT="ON"
else
    COLOR="$COLOR_OFF"
    TEXT="BT [OFF]"
    SHORT="OFF"
fi

# --- OUTPUT I3BLOCKS ---
echo "$TEXT"    # Full text
echo "$SHORT"   # Short text
echo "$COLOR"   # Color
